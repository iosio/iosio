{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import {isArray, isObj, isString} from \"@iosio/util\";\nimport {obi} from \"@iosio/obi\";\n\nexport const createRouting = () => {\n    let w = window,\n        toValue = (mix) => {\n            if (!mix) return '';\n            var str = decodeURIComponent(mix);\n            if (str === 'false') return false;\n            if (str === 'true') return true;\n            return (+str * 0 === 0) ? (+str) : str;\n        },\n        getParams = (str) => {\n            let tmp, k, out = {}, indi;\n            str = str || w.location.search;\n            indi = str.indexOf(\"?\");\n            if (indi < 0) return;\n            str = str.substr(indi + 1);\n            let arr = str.split('&');\n            while (tmp = arr.shift()) {\n                tmp = tmp.split('=');\n                k = tmp.shift();\n                if (out[k] !== void 0) out[k] = [].concat(out[k], toValue(tmp.shift()));\n                else out[k] = toValue(tmp.shift());\n            }\n            return out;\n        },\n        stringifyParams = (obj) => {\n            var enc = encodeURIComponent, k, i, tmp, str = '';\n            for (k in obj) {\n                if ((tmp = obj[k]) !== void 0) {\n                    if (isArray(tmp)) {\n                        for (i = 0; i < tmp.length; i++) {\n                            str && (str += '&');\n                            str += enc(k) + '=' + enc(tmp[i]);\n                        }\n                    } else {\n                        str && (str += '&');\n                        str += enc(k) + '=' + enc(tmp);\n                    }\n                }\n            }\n            return '?' + str;\n        },\n        getLocation = () => {\n            let {pathname, search} = w.location;\n            return {url: pathname + search, pathname, search, params: getParams()}\n        },\n        setUrl = (path, search, type) => {\n            search = isObj(search) ? stringifyParams(search) : search;\n            w.history[type + 'State'](null, null, path + search)\n        },\n\n        initLoc = getLocation(),\n\n        {url: _lastUrl, pathname: _lastPathname} = initLoc;\n\n    let routing = obi({\n        // pre-pending with $ ignores updates when setting them\n        $lastUrl: _lastUrl,\n        $lastPathname: _lastPathname,\n        $lastType: 'initial',\n        ...initLoc,\n        getParams,\n        stringifyParams,\n        getLocation,\n        route(pathOrSearchObj, search, type) {\n            let path = isString(pathOrSearchObj) ? pathOrSearchObj : location.pathname;\n            search = isObj(pathOrSearchObj) ? pathOrSearchObj : (search || '');\n            type = type || 'push';\n            const {pathname, url} = getLocation();\n            if (type !== 'replace') (_lastUrl = url, _lastPathname = pathname);\n            setUrl(path, search, type);\n            type === 'replace'\n                ? setTimeout(() => updateLocation({type}))\n                : updateLocation({type});\n        }\n    });\n\n    routing.routerSwitch = ({root, pathMap, noMatch}) => {\n        let next = null, toLast = false,\n            {pathname, $lastPathname, $lastUrl, $lastType, url} = routing,\n            noChange = url === $lastUrl;\n        noMatch = noMatch || '/';\n\n        if (root) next = pathMap['/' + pathname.split('/')[1]] || pathMap[noMatch];\n        else if (pathMap[pathname]) next = pathMap[pathname];\n        else if ($lastPathname !== pathname && pathMap[$lastPathname]) {\n            routing.route($lastUrl, location.search, 'replace');\n            next = pathMap[$lastPathname];\n            toLast = true;\n        } else if (noMatch && pathMap[noMatch]) {\n            routing.route(noMatch, location.search, 'replace');\n            next = pathMap[noMatch];\n        }\n        return {next, toLast, noChange, replacedLast: $lastType === 'replace'};\n    };\n\n    var updateLocation = (e) => {\n        routing.$merge({\n            ...getLocation(),\n            $lastUrl: e.type === 'popstate' ? routing.url : _lastUrl,\n            $lastPathname: e.type === 'popstate' ? routing.pathname : _lastPathname,\n            $lastType: e.type\n        })\n    };\n\n    w.addEventListener(\"popstate\", updateLocation);\n\n    return routing;\n};\n\nexport const routing = createRouting();\n\n"],"names":["createRouting","w","window","toValue","mix","str","decodeURIComponent","getParams","tmp","k","indi","out","location","search","indexOf","arr","substr","split","shift","concat","stringifyParams","obj","i","enc","encodeURIComponent","isArray","length","getLocation","pathname","url","params","initLoc","_lastUrl","_lastPathname","routing","obi","$lastUrl","$lastPathname","$lastType","route","pathOrSearchObj","type","path","isString","isObj","history","setUrl","setTimeout","updateLocation","routerSwitch","root","pathMap","noMatch","next","toLast","noChange","replacedLast","e","$merge","addEventListener"],"mappings":"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"}