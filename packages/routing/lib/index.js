import{isArray as t,isObj as e}from"@iosio/util";import{obi as a}from"@iosio/obi";const r=()=>{let r=window,o=t=>{if(!t)return"";var e=decodeURIComponent(t);return"false"!==e&&("true"===e||(0*+e==0?+e:e))},l=t=>{let e,a,l,n={};if((l=(t=t||r.location.search).indexOf("?"))<0)return;let s=(t=t.substr(l+1)).split("&");for(;e=s.shift();)n[a=(e=e.split("=")).shift()]=void 0!==n[a]?[].concat(n[a],o(e.shift())):o(e.shift());return n},n=e=>{var a,r,o,l=encodeURIComponent,n="";for(a in e)if(void 0!==(o=e[a]))if(t(o))for(r=0;r<o.length;r++)n&&(n+="&"),n+=l(a)+"="+l(o[r]);else n&&(n+="&"),n+=l(a)+"="+l(o);return"?"+n},s=()=>{let{pathname:t,search:e}=r.location;return{url:t+e,pathname:t,search:e,params:l()}},i=s(),{url:p,pathname:h}=i,c=a({$lastUrl:p,$lastPathname:h,$lastType:"initial",...i,getParams:l,stringifyParams:n,getLocation:s,route(t,a,o){o=o||"push",t=t||location.pathname,a=a||"";const{pathname:l,url:i}=s();"replace"!==o&&(p=i,h=l),((t,a,o)=>{a=e(a)?n(a):a,r.history[o+"State"](null,null,t+a)})(t,a,o),"replace"===o?setTimeout(()=>u({type:o})):u({type:o})}});c.routerSwitch=({root:t,pathMap:e,noMatch:a})=>{let r=null,o=!1,{pathname:l,$lastPathname:n,$lastUrl:s,$lastType:i,url:p}=c,h=p===s;return a=a||"/",t?r=e["/"+l.split("/")[1]]||e[a]:e[l]?r=e[l]:n!==l&&e[n]?(c.route(s,location.search,"replace"),r=e[n],o=!0):a&&e[a]&&(c.route(a,location.search,"replace"),r=e[a]),{next:r,toLast:o,noChange:h,replacedLast:"replace"===i}};var u=t=>{c.$merge({...s(),$lastUrl:"popstate"===t.type?c.url:p,$lastPathname:"popstate"===t.type?c.pathname:h,$lastType:t.type})};return r.addEventListener("popstate",u),c},o=r();export{r as createRouting,o as routing};
